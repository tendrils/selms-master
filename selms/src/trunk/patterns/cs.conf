[global] {
  maildomain = auckland.ac.nz
  hostdomain = auckland.ac.nz
  mail_server = mailhost.auckland.ac.nz
  log_dir = /logs/HOSTS
  offset = selms

    [actions] {
       Alert, warn:  email
       Alert rt:  email, acc 10 min  # send first alert and then acc 10 minutes
       warn rt:  acc 10 min, email  # accumulate for 10 minutes then send
       report : email
    }

  include +UNIX.conf


}

# this section tries to cover all the legit ssh, su and sudo activity

$CS_UNIX_ADMIN = (?:jnt-admin|robert-admin|james-admin)
$CS_DBA = (?:ianf|diva003|nlat007|amcl065|srav002|pjan005|asha210)


[service csunixadmin] {
  [realtime] {
    proc sudo	: warn      
  }
  [periodic] {
    proc sudo & re /^$CS_UNIX_ADMIN/					: drop
    proc su & re /'^su root' succeeded for $CS_UNIX_ADMIN/			: drop
    proc su & re /'^su \w+' succeeded for root/					: drop
    proc login & rec %r!^ROOT LOGIN /dev/pts/\d+!				: drop
    proc sshd & re /^Accepted publickey for $CS_UNIX_ADMIN from 130\.216\./	: drop

    proc sshd & /^Accepted password for $CS_UNIX_ADMIN/		: drop
    proc sshd & /^Accepted keyboard-interactive\/pam for $CS_UNIX_ADMIN/		: drop
    proc sshd & %r!^'su root' succeeded for root on /dev/\?\?\?!		: drop
  }
}

[service pam_krb5: proc ] {
  [periodic] {
    /authenticating/	: drop
    /configured realm/	: drop
     /flags: /	: drop
     /krb5_get_init_creds_password/	: drop
     /ticket lifetime/	: drop
     /renewable/	: drop
     /banner/		: drop
     /ccache dir/	: drop
     /keytab:/		: drop
     /called /		: drop
     /authentication succeeds /		: drop
     /minimum uid /		: drop
     /pam_acct_mgmt returning 0 /		: drop
     /got result 0 /		: drop
     /pam_authenticate returning 0/		: drop
     / /		: drop
     /trying previously/	: drop
 }
}

[service pam_unix: proc ] {
  [periodic] {
    /^(\w+).* authentication failure; .+ rhost=(\S+)?\s+user=(\S+)?/	:\
             count 5 "Possible %1 bruteforce of '%3' # failed logins" ,\
             count 10 "Possible %1 bruteforce from '%2' # failed logins", ignore
    /session closed/		: drop
    /session opened/		: drop
  }
}

[service cslinux  ] {
  service linux
  service sendmail
  service nagios
  service sshd
  service csunixadmin
  service pam_krb5
  service pam_unix

  [periodic] {
    proc kernel & /^Linux version/		: alert,  switch 'reboot'
    proc cron	: drop
    proc logger 	: drop
    proc syslog-ng & /^STATS:/		: ignore
    proc syslog-ng & /^AF_INET client/		: ignore

  }	

  [periodic reboot] {
    proc ntpd 			:  switch 'default'
    proc kernel			:  ignore
    proc vmkernel		:  ignore
    proc rc.sysinit		: ignore
    proc vmware			: ignore
    proc vmkload_mod		: ignore
    proc snmpd			: ignore
  }	
}

[service cslab ] {

  [periodic ] {
     proc scecli & %r!N/A: Security policy in the Group policy!		: drop
     proc 'symantec antivirus' & %r!^N/A:  New virus definition file loaded!	:drop
     proc 'symantec antivirus' & %r!^N/A:  Scan starte!	:drop
     proc 'symantec antivirus' & %r!^N/A:  Scan Complete:  Risks: 0!	:drop
     proc  wsh &  %r!N/A: Win2k Login for user:!			:drop
     /^nss_ldap: failed to bind to LDAP server (.+): /	: count 10 "ldap failed to bind to %1", drop
     /^nss_ldap: could not search LDAP server/	: count 10 "ldap could not search", drop
     /^nss_ldap: reconnecting to LDAP server/	: drop
     proc ntpd	: ignore
  }
}

[service ntauth ] {

  [periodic ] {
    proc security & /Special privileges assigned to new/	: drop
    proc security & /User Logoff: User Name:/	: drop
    proc security & /Successful (Network )?Logon/		:drop
    proc security & /User Logoff:/			: drop
    proc 'eventlog returned error'  & /error 31/	: drop
    proc 'service control manager' 			: drop
    proc loadperf & /successfully/			: drop
#    proc =~ /^eventlog to/				: drop
    proc msmq & %r!^N/A: The Message Queuing service st!	: drop
    proc msmq & %r!^N/A: The Message Queuing service is online!	: drop
    proc w32time & %r!^N/A: The time service is now syn!	: drop
    proc 'symantec antivirus' & %r!^N/A:  Symantec AntiVirus services startup was start!	: drop
    proc security & /^NT AUTHORITY.SYSTEM: Logon Failure.+Name: (\S+) Domain: (.+) Type:/	: count 5 "Repeated login failures for %1@%2" , drop
    proc prelogon & /^NT AUTHORITY.SYSTEM: Script completed successfully/	: drop
    proc rconsvc & %r!^N/A: Remote Console Server 2.02 has started suc!	: drop
    proc uphclean & %r!^N/A: User profile hive cleanup service.+ start!	: drop
    proc wmpnetworksvc  & %r!^N/A: Service 'WMPNetworkSvc' started!	: drop
    proc security & /^[^:]+: User initiated logoff/			: drop
    proc wsh & %r!^N/A: Win2k Logout for user!				: drop
    proc msmqtriggers  & %r!^N/A: Message Queuing Triggers started suc!	: drop


  }
}

############################## hosts ###################################


# default definition for CS machines -- should matc all machines

[host cs : /^cs-/	; priority => 0; email=>r.fulton ] {
   service cslinux
}

[host cs-lab:  /^cs-(bcl|btl|fcl|ftl|gcl|gl4|gl5|gtl|ocl|otl)[a-jt][0-9]{1,2}\.sfac/	; 
               priority=> 5; email=>r.fulton ] {
  service ntauth
  service cslab
  service cslinux
}

[host cs-lab2: /^cs-t\d+-\d+-\d+\.sfac/	;priority=> 5; email=>r.fulton ] {
  service ntauth
  service cslab
  service cslinux

}

[host cs-lab3: /^cs-130\.216/	;priority=> 5; email=>r.fulton ] {
  service ntauth
  service cslinux
  service cslab

}

[host cs-image: /^cs-image/	;priority=> 5; email=>r.fulton ] {
  service cslinux

  [periodic]  {
    proc atftpd & /^Serving/		: drop
    proc atftpd & /^Fetching/		: drop
    proc atd & /^File (\S+) is in wrong format/	:count 10 "atftpd file %1 is in wrong format", drop
    proc in.tftpd & /^RRQ from/		: drop
    proc in.tftpd & /^tftp: client does not accept options/		: drop
    proc in.tftpd & /^sending NAK/		: drop
  }

}

	 

[host cs-stf:  /^cs-stf.+\.cs/	; priority=> 5; email=>r.fulton ] {
   service ntauth
   service cslinux
}

[host cs-ecdir:  /^cs-ecdir.+\.ec/	; priority=> 5; email=>r.fulton ] {
   service cslinux

  [periodic] {
  }
}


[host cs-www: /cs-www\d+.sfac/	; merge  no ; file=>user ( apache ); email=>r.fulton ] {
   service cslinux

  [periodic] {

  } 

  [periodic apache] {
    status  < 400	: drop
  }


}



[host cs-subversion.sfac: merge  no ; file=>user ( apache ); email=>r.fulton ] {
   service cslinux

  [periodic] {

  } 

  [periodic apache] {
    status  < 400	: drop
    request =~ /^PROPFIND (\S+)/	: count 10 "PROFIND %1" , drop
  }


}

[host  cs-mnemosyne.cs:	 email=>r.fulton ] {
   service cslinux

  [periodic] {
    proc nagios2  	: drop
    proc syslog.cs.auckland.ac.nz : drop
  }
}

[host  cs-wwwrsync.cs:  email=>r.fulton ] {
   service cslinux

  [periodic] {
    proc syslog-ng & /^Log statistics/  	: drop
    proc rsyncd					: drop 
 
  }
}
